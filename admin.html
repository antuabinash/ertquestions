<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>eRT Odisha - Admin Fast</title>
    <style>
        :root {
            --primary: #0d47a1;
            --bg-color: #f4f6f8;
            --success: #2e7d32;
        }
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: var(--bg-color); color: #333; }
        .container { max-width: 1200px; margin: auto; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden; border-top: 5px solid var(--primary); }
        
        /* HEADER & TABS */
        .header { display: flex; align-items: center; padding: 20px; gap: 15px; border-bottom: 1px solid #eee; }
        .app-logo { height: 40px; width: 40px; border-radius: 50%; }
        h1 { margin: 0; color: var(--primary); font-size: 1.5rem; }

        .tabs { display: flex; background: #e3f2fd; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: transparent; cursor: pointer; font-weight: bold; color: #555; border-bottom: 3px solid transparent; transition: 0.2s; }
        .tab-btn:hover { background: #bbdefb; }
        .tab-btn.active { background: white; color: var(--primary); border-bottom: 3px solid var(--primary); }

        /* TOOLBAR */
        .toolbar { padding: 15px; background: #fafafa; border-bottom: 1px solid #eee; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .btn-load { background: #546e7a; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: auto; }

        /* TABLE */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; border-bottom: 1px solid #eee; text-align: left; vertical-align: top; }
        th { background: #f5f5f5; color: #444; font-weight: 700; text-transform: uppercase; font-size: 0.85em; }
        tr:hover { background-color: #fcfcfc; }
        
        .content-text { word-wrap: break-word; font-size: 0.95rem; }
        .thumb { max-width: 80px; max-height: 80px; border: 1px solid #ddd; padding: 2px; background: white; margin-top: 5px; border-radius: 4px; }

        /* EDIT & ACTIONS */
        .edit-box { display: none; margin-top: 10px; background: #fffde7; padding: 15px; border: 1px solid #fff59d; border-radius: 6px; }
        .edit-box input, .edit-box textarea { width: 100%; margin: 5px 0; padding: 8px; box-sizing: border-box; border: 1px solid #ddd; }
        
        .action-col { display: flex; flex-direction: column; gap: 5px; }
        .btn-verify { background: var(--success); color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn-unverify { background: #fb8c00; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; width: 100%; }
        .btn-edit, .btn-del { padding: 6px; border: none; border-radius: 4px; cursor: pointer; color: white; }
        .btn-edit { background: #1976d2; } .btn-del { background: #d32f2f; }

        /* EDITOR */
        #fs-editor { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: none; flex-direction: column; }
        .ed-toolbar { background: #eee; padding: 10px; display: flex; gap: 10px; border-bottom: 1px solid #ccc; }
        .ed-content { flex: 1; padding: 30px; outline: none; overflow-y: auto; font-size: 1.2rem; }
        
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 25px; height: 25px; animation: spin 1s linear infinite; margin: auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="fs-editor">
        <div class="ed-toolbar">
            <button onclick="document.execCommand('bold')"><b>B</b></button>
            <button onclick="document.execCommand('italic')"><i>I</i></button>
            <div style="flex-grow:1"></div>
            <button onclick="closeEditor()" style="background:var(--primary); color:white; border:none; padding:5px 15px; border-radius:4px; cursor:pointer;">Save & Close</button>
        </div>
        <div id="ed-body" class="ed-content" contenteditable="true"></div>
    </div>

    <div class="container">
        <div class="header">
            <img src="logo.jpg" alt="Logo" class="app-logo">
            <h1>eRT Admin Panel</h1>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('pending')" id="tab-pending">üî¥ Pending Review</button>
            <button class="tab-btn" onclick="switchTab('all')" id="tab-all">üìÇ All History</button>
        </div>

        <div class="toolbar">
            <select id="f-exam" onchange="render()"><option value="all">All Exams</option></select>
            <select id="f-teacher" onchange="render()"><option value="all">All Teachers</option></select>
            <select id="f-subject" onchange="render()"><option value="all">All Subjects</option></select>
            <button class="btn-load" onclick="loadMore()">‚Üª Load More</button>
        </div>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th style="width:20%">Info</th>
                        <th style="width:40%">Question</th>
                        <th style="width:25%">Answer</th>
                        <th style="width:15%">Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="4" style="text-align:center; padding:30px;"><div class="loader"></div></td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { db } from "./firebase-config.js";
        import { collection, onSnapshot, deleteDoc, updateDoc, doc, query, orderBy, limit, where } 
        from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // AUTH
        if(prompt("Password:") !== "admin123") { document.body.innerHTML = "Access Denied"; throw "Stop"; }

        // STATE
        let allData = [];
        let currentTab = 'pending';
        let queryLimit = 50;
        let unsubscribe = null;
        let activeEditId = null;

        const tableBody = document.getElementById('tableBody');

        // --- CORE LOGIC ---
        window.switchTab = (tab) => {
            currentTab = tab;
            queryLimit = 50; // Reset limit
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:30px;"><div class="loader"></div></td></tr>`;
            fetchData();
        }

        function fetchData() {
            if(unsubscribe) unsubscribe();
            const col = collection(db, "questions");
            let q;

            // SMART QUERY STRATEGY (No Indexes Needed)
            if(currentTab === 'pending') {
                // Get unverified. NO 'orderBy' here prevents index errors.
                // We will sort in Javascript instead.
                q = query(col, where("verified", "==", false), limit(queryLimit));
            } else {
                // Get everything by time. Standard query.
                q = query(col, orderBy("timestamp", "desc"), limit(queryLimit));
            }

            unsubscribe = onSnapshot(q, (snapshot) => {
                allData = [];
                snapshot.forEach(d => allData.push({ ...d.data(), id: d.id }));
                
                // If we are in 'pending' tab, manually sort by timestamp (newest first)
                // This replaces the database sort to avoid index requirements
                if(currentTab === 'pending') {
                    allData.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                }

                updateFilters();
            });
        }

        function updateFilters() {
            const exams = [...new Set(allData.map(d => d.exam).filter(Boolean))];
            const teachers = [...new Set(allData.map(d => d.teacher))];
            const subjects = [...new Set(allData.map(d => d.subject))];
            
            fillSelect('f-exam', exams);
            fillSelect('f-teacher', teachers);
            fillSelect('f-subject', subjects);
            render();
        }

        function fillSelect(id, items) {
            const el = document.getElementById(id);
            const current = el.value;
            el.innerHTML = `<option value="all">All</option>` + items.map(i => `<option value="${i}">${i}</option>`).join('');
            if(items.includes(current)) el.value = current;
        }

        window.render = () => {
            const ex = document.getElementById('f-exam').value;
            const te = document.getElementById('f-teacher').value;
            const su = document.getElementById('f-subject').value;

            const filtered = allData.filter(d => 
                (ex === 'all' || d.exam === ex) && 
                (te === 'all' || d.teacher === te) && 
                (su === 'all' || d.subject === su)
            );

            if(filtered.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:#888; padding:30px;">
                    ${currentTab === 'pending' ? 'üéâ All caught up! No pending questions.' : 'No data found.'}
                </td></tr>`;
                return;
            }

            const frag = document.createDocumentFragment();
            filtered.forEach(item => {
                const tr = document.createElement('tr');
                const isSub = item.type === "SUBJECTIVE";
                
                // Verify Button Logic
                const btnAction = currentTab === 'pending' 
                    ? `<button class="btn-verify" onclick="doVerify(this, '${item.id}', true)">‚úÖ Approve</button>`
                    : `<button class="btn-unverify" onclick="doVerify(this, '${item.id}', false)">‚Ü© Reject</button>`;

                tr.innerHTML = `
                    <td>
                        <span style="color:#0d47a1; font-weight:bold;">${item.exam || '-'}</span><br>
                        ${item.teacher}<br><small style="color:gray">${item.subject}</small>
                    </td>
                    <td>
                        <div id="view-${item.id}" class="content-text">
                            ${item.question}
                            ${item.imageUrl ? `<br><a href="${item.imageUrl}" target="_blank"><img src="${item.imageUrl}" class="thumb"></a>` : ''}
                        </div>
                        <div id="edit-${item.id}" class="edit-box">
                            <label>Question:</label> <span onclick="openEditor('q-${item.id}')" style="cursor:pointer; font-size:12px">‚úè Visual</span>
                            <textarea id="q-${item.id}" rows="3">${item.question}</textarea>
                            <label>New Image:</label><input type="file" id="img-${item.id}">
                            ${isSub ? `
                                <label>Answer:</label> <span onclick="openEditor('ans-${item.id}')" style="cursor:pointer; font-size:12px">‚úè Visual</span>
                                <textarea id="ans-${item.id}" rows="3">${item.answerText || ''}</textarea>
                            ` : `
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px">
                                    <input id="opA-${item.id}" value="${item.options?.A||''}" placeholder="A">
                                    <input id="opB-${item.id}" value="${item.options?.B||''}" placeholder="B">
                                    <input id="opC-${item.id}" value="${item.options?.C||''}" placeholder="C">
                                    <input id="opD-${item.id}" value="${item.options?.D||''}" placeholder="D">
                                </div>
                                <label>Correct:</label>
                                <select id="cor-${item.id}">
                                    <option value="A" ${item.answer==='A'?'selected':''}>A</option>
                                    <option value="B" ${item.answer==='B'?'selected':''}>B</option>
                                    <option value="C" ${item.answer==='C'?'selected':''}>C</option>
                                    <option value="D" ${item.answer==='D'?'selected':''}>D</option>
                                </select>
                            `}
                            <div style="margin-top:10px; display:flex; gap:5px;">
                                <button class="btn-edit" onclick="saveEdit('${item.id}', '${item.type}')">Save</button>
                                <button style="padding:6px; cursor:pointer;" onclick="toggleEdit('${item.id}')">Cancel</button>
                            </div>
                        </div>
                    </td>
                    <td>
                        ${isSub ? 
                            `<div class="content-text">${item.answerText||'-'}</div>` : 
                            `<b>Ans: ${item.answer}</b><br><small>A:${item.options?.A||'-'} B:${item.options?.B||'-'}</small>`
                        }
                    </td>
                    <td>
                        <div class="action-col">
                            ${btnAction}
                            <button class="btn-edit" onclick="toggleEdit('${item.id}')">‚úè Edit</button>
                            <button class="btn-del" onclick="del('${item.id}')">üóë</button>
                        </div>
                    </td>
                `;
                frag.appendChild(tr);
            });
            tableBody.innerHTML = "";
            tableBody.appendChild(frag);
        }

        // --- ACTIONS ---
        window.loadMore = () => { queryLimit += 50; fetchData(); }
        
        window.doVerify = async (btn, id, status) => {
            btn.innerText = ".."; btn.disabled = true;
            try { await updateDoc(doc(db, "questions", id), { verified: status }); }
            catch(e) { alert(e); btn.innerText = "Error"; btn.disabled = false; }
        }

        window.del = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db, "questions", id)); }
        
        window.toggleEdit = (id) => {
            const v = document.getElementById(`view-${id}`);
            const e = document.getElementById(`edit-${id}`);
            v.style.display = v.style.display === 'none' ? 'block' : 'none';
            e.style.display = e.style.display === 'block' ? 'none' : 'block';
        }

        // --- EDITOR & SAVING ---
        window.openEditor = (id) => {
            activeEditId = id;
            document.getElementById('ed-body').innerHTML = document.getElementById(id).value;
            document.getElementById('fs-editor').style.display = 'flex';
        }
        window.closeEditor = () => {
            document.getElementById(activeEditId).value = document.getElementById('ed-body').innerHTML;
            document.getElementById('fs-editor').style.display = 'none';
        }

        const compress = (file) => new Promise(resolve => {
            const r = new FileReader(); r.readAsDataURL(file);
            r.onload = e => {
                const i = new Image(); i.src = e.target.result;
                i.onload = () => {
                    const c = document.createElement('canvas');
                    c.width = Math.min(i.width, 800);
                    c.height = i.height*(c.width/i.width);
                    c.getContext('2d').drawImage(i,0,0,c.width,c.height);
                    resolve(c.toDataURL('image/jpeg',0.7));
                }
            }
        });

        window.saveEdit = async (id, type) => {
            const btn = document.querySelector(`#edit-${id} .btn-edit`);
            btn.innerText = "Saving"; btn.disabled = true;
            try {
                let up = { question: document.getElementById(`q-${id}`).value };
                const f = document.getElementById(`img-${id}`).files[0];
                if(f) up.imageUrl = await compress(f);

                if(type === 'SUBJECTIVE') {
                    up.answerText = document.getElementById(`ans-${id}`).value;
                } else {
                    up.options = {
                        A: document.getElementById(`opA-${id}`).value,
                        B: document.getElementById(`opB-${id}`).value,
                        C: document.getElementById(`opC-${id}`).value,
                        D: document.getElementById(`opD-${id}`).value
                    };
                    up.answer = document.getElementById(`cor-${id}`).value;
                }
                await updateDoc(doc(db, "questions", id), up);
                toggleEdit(id);
            } catch(e) { alert(e); }
            btn.innerText = "Save"; btn.disabled = false;
        }

        // INIT
        fetchData();
    </script>
</body>
</html>
