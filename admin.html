<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>eRT Odisha - Admin</title>
    <style>
        /* --- ADMIN THEME --- */
        :root {
            --primary: #0d47a1;
            --primary-hover: #002171;
            --accent: #d32f2f;
            --bg-color: #f4f6f8;
            --success: #2e7d32;
            --card-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: var(--bg-color); color: #333; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: var(--card-shadow); border-top: 5px solid var(--primary); }
        
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .app-logo { height: 50px; width: 50px; border-radius: 50%; object-fit: cover; }
        h1 { margin: 0; color: var(--primary); font-size: 1.8rem; }

        /* Toolbar */
        .toolbar { display: flex; gap: 20px; background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 25px; flex-wrap: wrap; border: 1px solid #e0e0e0; align-items: center; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-size: 0.85em; font-weight: bold; color: #555; margin-bottom: 5px; text-transform: uppercase; }
        select { padding: 10px; min-width: 180px; border-radius: 6px; border: 1px solid #ccc; }
        
        .btn-dl { background: var(--primary); color: white; border: none; padding: 12px 24px; cursor: pointer; border-radius: 6px; font-weight: bold; margin-left: auto;}
        
        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; border-radius: 8px; overflow: hidden; }
        th, td { border: 1px solid #dee2e6; padding: 15px; text-align: left; vertical-align: top; }
        th { background: var(--primary); color: white; font-weight: 600; text-transform: uppercase; font-size: 0.9em; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        
        /* PRESERVE LINE BREAKS IN TABLE */
        .content-text { white-space: pre-wrap; word-wrap: break-word; }

        .thumb { max-width: 80px; max-height: 80px; border: 1px solid #ddd; padding: 3px; background: white; border-radius: 4px; display: block; margin-top: 5px;}
        .ans-thumb { border-color: #2e7d32; } 

        /* Edit Box */
        .edit-box { display: none; margin-top: 15px; background: #fff8e1; padding: 20px; border: 1px solid #ffe0b2; border-radius: 8px; }
        .edit-box label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.8em; color: #d84315; }
        .edit-box input, .edit-box textarea, .edit-box select { width: 100%; margin-top: 5px; border: 1px solid #f9a825; display:block; margin-bottom: 10px; box-sizing: border-box; padding: 8px; }
        .edit-btns { margin-top: 15px; display: flex; gap: 10px; }

        /* Action Buttons */
        .action-container { display: flex; flex-direction: column; gap: 8px; }
        .btn-verify { background: var(--success); color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn-unverify { background: #607d8b; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; width: 100%; }
        .btn-edit { background: #546e7a; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; width: 100%; }
        .btn-delete { background: var(--accent); color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; width: 100%; }

        .badge-verified {
            display: inline-block; background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9;
            padding: 4px 8px; border-radius: 12px; font-size: 0.75em; font-weight: bold; text-transform: uppercase; margin-bottom: 8px;
        }

        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <img src="logo.jpg" alt="Logo" class="app-logo">
            <h1>eRT Odisha - Admin Panel</h1>
        </div>
        
        <div class="toolbar">
            <div class="filter-group">
                <label>1. Exam:</label>
                <select id="filterExam" onchange="applyFilters()">
                    <option value="all">All Exams</option>
                </select>
            </div>
            <div class="filter-group">
                <label>2. Teacher:</label>
                <select id="filterTeacher" onchange="applyFilters()">
                    <option value="all">All Teachers</option>
                </select>
            </div>
            <div class="filter-group">
                <label>3. Subject:</label>
                <select id="filterSubject" onchange="applyFilters()">
                    <option value="all">All Subjects</option>
                </select>
            </div>
            <button class="btn-dl" onclick="downloadJSON()">‚¨á Download Verified JSON</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width:20%">Info</th>
                    <th style="width:35%">Question</th>
                    <th style="width:30%">Answer / Options</th>
                    <th style="width:15%">Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="4" style="text-align:center; padding:40px;"><div class="loader"></div><p style="margin-top:10px; color:#666;">Loading data...</p></td></tr>
            </tbody>
        </table>
    </div>

    <script type="module">
        import { db } from "./firebase-config.js";
        import { collection, onSnapshot, deleteDoc, updateDoc, doc, query, orderBy, enableIndexedDbPersistence } 
        from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        enableIndexedDbPersistence(db).catch((err) => console.log("Persistence suppressed."));

        const pass = prompt("Enter Admin Password:");
        if(pass !== "admin123") { document.body.innerHTML = "<h1 style='text-align:center; margin-top:50px; color:red;'>‚õî Access Denied</h1>"; throw new Error("Stop"); }

        let allData = [];
        const examSelect = document.getElementById('filterExam');
        const teacherSelect = document.getElementById('filterTeacher');
        const subjectSelect = document.getElementById('filterSubject');
        const tableBody = document.getElementById('tableBody');

        // --- FETCH DATA ---
        onSnapshot(query(collection(db, "questions"), orderBy("timestamp", "desc")), (snapshot) => {
            allData = [];
            snapshot.forEach(doc => allData.push({ ...doc.data(), id: doc.id }));
            updateDropdowns();
        });

        // --- DROPDOWNS ---
        function updateDropdowns() {
            const currentExam = examSelect.value;
            const currentTeacher = teacherSelect.value;
            const currentSubject = subjectSelect.value;

            const exams = [...new Set(allData.map(d => d.exam).filter(Boolean))];
            populateSelect(examSelect, exams, "All Exams", currentExam);

            const teachers = [...new Set(allData.map(d => d.teacher))];
            populateSelect(teacherSelect, teachers, "All Teachers", currentTeacher);

            const subjects = [...new Set(allData.map(d => d.subject))];
            populateSelect(subjectSelect, subjects, "All Subjects", currentSubject);
            
            applyFilters();
        }

        function populateSelect(el, items, defaultText, selectedValue) {
            el.innerHTML = `<option value="all">${defaultText}</option>`;
            items.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item; opt.innerText = item;
                if(item === selectedValue) opt.selected = true;
                el.appendChild(opt);
            });
        }

        // --- FILTER ---
        window.applyFilters = () => {
            const e = examSelect.value;
            const t = teacherSelect.value;
            const s = subjectSelect.value;
            const filtered = allData.filter(item => {
                return (e === "all" || item.exam === e) && (t === "all" || item.teacher === t) && (s === "all" || item.subject === s);
            });
            renderTable(filtered);
        }

        // --- RENDER TABLE ---
        function renderTable(data) {
            tableBody.innerHTML = "";
            if(data.length === 0) { tableBody.innerHTML = "<tr><td colspan='4' style='text-align:center; padding:30px; color:#777;'>No questions found.</td></tr>"; return; }
            
            data.forEach(item => {
                const isVerified = item.verified === true;
                const verifiedBadge = isVerified ? `<div class="badge-verified">‚úÖ Verified</div>` : '';
                const verifyBtn = isVerified ? `<button class="btn-unverify" onclick="window.toggleVerify('${item.id}', false)">‚Ü© Undo</button>` : `<button class="btn-verify" onclick="window.toggleVerify('${item.id}', true)">‚úÖ Verify</button>`;
                
                const isSubjective = item.type === "SUBJECTIVE";

                // 1. Build Answer Column HTML
                let answerDisplay = "";
                if (isSubjective) {
                    answerDisplay = `
                        <div style="font-size:0.9em;">
                            <span style="color:#d32f2f; font-weight:bold; font-size:0.8em; border:1px solid #d32f2f; padding:2px 4px; border-radius:4px;">${item.category || 'Subjective'}</span><br>
                            <div class="content-text" style="margin-top:5px;">${item.answerText || '<i>No text answer</i>'}</div>
                            ${item.answerImage ? `<a href="${item.answerImage}" target="_blank"><img src="${item.answerImage}" class="thumb ans-thumb" title="Answer Image"></a>` : ''}
                        </div>`;
                } else {
                    answerDisplay = `
                        <div style="font-size:0.85em;">
                            A: ${item.options?.A || ''}<br>B: ${item.options?.B || ''}<br>
                            C: ${item.options?.C || ''}<br>D: ${item.options?.D || ''}<br>
                            <strong style="color:#d32f2f; display:block; margin-top:5px;">Ans: ${item.answer}</strong>
                        </div>`;
                }

                // 2. Build Edit Form
                let editFields = "";
                if (isSubjective) {
                    editFields = `
                        <label>Category:</label>
                        <select id="cat-${item.id}">
                            <option value="Very Short" ${item.category === 'Very Short' ? 'selected' : ''}>Very Short</option>
                            <option value="Short" ${item.category === 'Short' ? 'selected' : ''}>Short</option>
                            <option value="Long" ${item.category === 'Long' ? 'selected' : ''}>Long</option>
                        </select>
                        <label>Answer Text:</label> <textarea id="ansTxt-${item.id}" rows="3">${item.answerText || ''}</textarea>
                        <label>New Answer Image:</label> <input type="file" id="ansFile-${item.id}">
                    `;
                } else {
                    editFields = `
                        <label>Options:</label>
                        <input type="text" id="opA-${item.id}" value="${item.options?.A || ''}" placeholder="A">
                        <input type="text" id="opB-${item.id}" value="${item.options?.B || ''}" placeholder="B">
                        <input type="text" id="opC-${item.id}" value="${item.options?.C || ''}" placeholder="C">
                        <input type="text" id="opD-${item.id}" value="${item.options?.D || ''}" placeholder="D">
                        <label>Correct Ans:</label>
                        <select id="ansMCQ-${item.id}">
                            <option value="A" ${item.answer === 'A' ? 'selected' : ''}>A</option>
                            <option value="B" ${item.answer === 'B' ? 'selected' : ''}>B</option>
                            <option value="C" ${item.answer === 'C' ? 'selected' : ''}>C</option>
                            <option value="D" ${item.answer === 'D' ? 'selected' : ''}>D</option>
                        </select>
                    `;
                }

                // 3. Render Row
                tableBody.innerHTML += `
                    <tr>
                        <td>
                            <span style="color:#0d47a1; font-weight:bold; text-transform:uppercase;">${item.exam || 'No Exam'}</span><br>
                            <b>${item.teacher}</b><br>
                            <small style="color:gray">${item.subject}</small>
                        </td>
                        <td>
                            ${verifiedBadge}
                            <div id="disp-q-${item.id}" class="content-text">
                                ${item.question}
                                ${item.imageUrl ? `<br><a href="${item.imageUrl}" target="_blank"><img src="${item.imageUrl}" class="thumb"></a>` : ''}
                            </div>
                            
                            <div id="edit-${item.id}" class="edit-box">
                                <label>Question:</label> <textarea id="txt-${item.id}" rows="3">${item.question}</textarea>
                                <label>New Question Image:</label> <input type="file" id="file-${item.id}">
                                
                                ${editFields}

                                <div class="edit-btns">
                                    <button onclick="window.saveAdminEdit('${item.id}', '${item.type}')" style="background:#0d47a1; color:white; border:none; padding:8px 16px; border-radius:4px;">Save</button>
                                    <button onclick="window.toggleEdit('${item.id}')" style="background:#777; color:white; border:none; padding:8px 16px; border-radius:4px;">Cancel</button>
                                </div>
                            </div>
                        </td>
                        <td>
                            ${answerDisplay}
                        </td>
                        <td>
                            <div class="action-container">
                                ${verifyBtn}
                                <button class="btn-edit" onclick="window.toggleEdit('${item.id}')">‚úè Edit</button>
                                <button class="btn-delete" onclick="window.deleteQ('${item.id}')">üóë Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        // --- ACTIONS ---
        window.toggleVerify = async (id, status) => { try { await updateDoc(doc(db, "questions", id), { verified: status }); } catch (e) { alert("Error: " + e.message); } }
        window.deleteQ = async (id) => { if(confirm("Delete permanently?")) await deleteDoc(doc(db, "questions", id)); }

        window.toggleEdit = (id) => {
            const box = document.getElementById(`edit-${id}`);
            const dispQ = document.getElementById(`disp-q-${id}`);
            if (box.style.display === "block") { box.style.display = "none"; dispQ.style.display = "block"; } 
            else { box.style.display = "block"; dispQ.style.display = "none"; }
        }

        // IMAGE HELPER
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image(); img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const maxWidth = 800; const scaleSize = maxWidth / img.width;
                        canvas.width = (img.width > maxWidth) ? maxWidth : img.width;
                        canvas.height = (img.width > maxWidth) ? (img.height * scaleSize) : img.height;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                    };
                };
                reader.onerror = (error) => reject(error);
            });
        };

        // --- SAVE EDIT ---
        window.saveAdminEdit = async (id, type) => {
            const btn = document.querySelector(`#edit-${id} button`); btn.innerText = "Saving...";
            try {
                const qFile = document.getElementById(`file-${id}`).files[0];
                let updates = { question: document.getElementById(`txt-${id}`).value };

                if (qFile) {
                    if(qFile.size > 5*1024*1024) throw new Error("Image too large");
                    updates.imageUrl = await compressImage(qFile);
                }

                if (type === "SUBJECTIVE") {
                    updates.category = document.getElementById(`cat-${id}`).value;
                    updates.answerText = document.getElementById(`ansTxt-${id}`).value;
                    const aFile = document.getElementById(`ansFile-${id}`).files[0];
                    if (aFile) {
                        if(aFile.size > 5*1024*1024) throw new Error("Image too large");
                        updates.answerImage = await compressImage(aFile);
                    }
                } else {
                    updates.options = {
                        A: document.getElementById(`opA-${id}`).value,
                        B: document.getElementById(`opB-${id}`).value,
                        C: document.getElementById(`opC-${id}`).value,
                        D: document.getElementById(`opD-${id}`).value,
                    };
                    updates.answer = document.getElementById(`ansMCQ-${id}`).value;
                }

                await updateDoc(doc(db, "questions", id), updates);
                alert("Updated!");
                btn.innerText = "Save";
                window.toggleEdit(id); // Close edit box
            } catch (e) {
                alert("Error: " + e.message); btn.innerText = "Save";
            }
        };

        window.downloadJSON = () => {
            const e = examSelect.value; const t = teacherSelect.value; const s = subjectSelect.value;
            const dataToDownload = allData.filter(item => {
                return (e === "all" || item.exam === e) && (t === "all" || item.teacher === t) && (s === "all" || item.subject === s) && item.verified === true;
            });
            if (dataToDownload.length === 0) return alert("No VERIFIED questions found.");
            
            const filename = `Questions_${Date.now()}.json`;
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dataToDownload, null, 2));
            const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", filename);
            document.body.appendChild(dl); dl.click(); dl.remove();
        }
    </script>
</body>
</html>
