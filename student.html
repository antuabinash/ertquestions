<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eRT Odisha - Student Portal</title>
    <style>
        /* --- THEME COLORS (Matches Teacher/Admin) --- */
        :root {
            --primary: #0d47a1; /* Dark Blue */
            --primary-hover: #002171;
            --accent: #d32f2f; /* Red */
            --bg-color: #f4f6f8;
            --correct: #2e7d32; /* Green */
            --wrong: #c62828; /* Red */
            --card-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; max-width: 800px; margin: auto; background-color: var(--bg-color); color: #333; }

        /* --- HEADER --- */
        .top-bar { 
            background: var(--primary); 
            padding: 15px 20px; 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            gap: 15px;
            box-shadow: var(--card-shadow);
            color: white;
            margin-bottom: 30px;
        }
        .app-logo { height: 50px; width: 50px; border-radius: 50%; border: 2px solid white; background: white; object-fit: cover; }
        .top-bar h1 { margin: 0; font-size: 1.4rem; line-height: 1.2; font-weight: 600; }
        .sub-text { font-size: 0.7em; font-weight: 400; opacity: 0.9; display: block; }

        /* --- GRID TILES (Exams & Subjects) --- */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        
        .tile {
            background: white;
            padding: 30px 15px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border-bottom: 5px solid var(--primary);
            font-weight: bold;
            font-size: 1.1em;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .tile:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .tile:active { transform: scale(0.98); }

        /* Subject Tile Variant */
        .tile.subject-tile { border-bottom-color: var(--accent); color: var(--accent); }

        /* --- QUIZ QUESTION CARD --- */
        .quiz-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            animation: fadeIn 0.4s ease-out;
            border-top: 4px solid var(--primary);
        }
        
        .q-text { font-size: 1.15em; font-weight: 600; margin-bottom: 15px; color: #222; line-height: 1.4; }
        .q-img { max-width: 100%; height: auto; border-radius: 8px; margin-bottom: 15px; border: 1px solid #eee; display: block; }
        
        .options-grid { display: grid; gap: 10px; }
        
        .opt-btn {
            padding: 14px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            font-size: 1em;
            transition: all 0.2s;
            color: #444;
            font-weight: 500;
        }
        .opt-btn:hover { background-color: #f5f5f5; border-color: #bbb; }

        /* Correct/Wrong States */
        .opt-btn.correct { background-color: #e8f5e9 !important; border-color: var(--correct) !important; color: var(--correct); font-weight: bold; }
        .opt-btn.wrong { background-color: #ffebee !important; border-color: var(--wrong) !important; color: var(--wrong); opacity: 0.8; }

        /* --- NAVIGATION & HELPERS --- */
        .nav-header { display: flex; align-items: center; margin-bottom: 20px; }
        .back-btn { 
            background: white; border: 1px solid #ccc; font-size: 1.2rem; cursor: pointer; color: var(--primary); 
            margin-right: 15px; padding: 5px 12px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .back-btn:hover { background-color: #e3f2fd; border-color: var(--primary); }
        .section-title { font-size: 1.3rem; font-weight: bold; color: #444; }

        .hidden { display: none; }
        
        /* Loader Animation */
        .loader-container { text-align: center; padding: 50px; color: #666; }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Offline Message */
        .offline-msg { text-align: center; padding: 50px; }
        .retry-btn { margin-top: 15px; padding: 10px 25px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; }
    </style>
</head>
<body>

    <div class="top-bar">
        <img src="logo.jpg" alt="Logo" class="app-logo">
        <h1>eRT Odisha<br><span class="sub-text">Student Learning Portal</span></h1>
    </div>

    <div id="app-content">
        <div id="view-exams">
            <h2 style="color:#555; text-align:center; margin-bottom:25px; font-weight:500;">Select Your Exam</h2>
            <div class="grid-container" id="exam-grid">
                </div>
        </div>

        <div id="view-subjects" class="hidden">
            <div class="nav-header">
                <button class="back-btn" onclick="goBackToExams()">⬅</button>
                <span class="section-title" id="selected-exam-title">Exam Name</span>
            </div>
            <div class="grid-container" id="subject-grid">
                </div>
        </div>

        <div id="view-quiz" class="hidden">
            <div class="nav-header">
                <button class="back-btn" onclick="goBackToSubjects()">⬅</button>
                <span class="section-title" id="selected-subject-title">Subject Name</span>
            </div>
            <div id="quiz-list">
                </div>
        </div>
    </div>

    <script type="module">
        import { db } from "./firebase-config.js";
        import { collection, query, where, getDocs, orderBy, enableIndexedDbPersistence } 
        from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Enable Offline Persistence for Students
        enableIndexedDbPersistence(db).catch((err) => {
            console.log("Persistence suppressed (Likely multiple tabs open).");
        });

        // --- OFFLINE DETECTION ---
        window.addEventListener('online', () => window.location.reload());
        if (!navigator.onLine) {
            document.getElementById('app-content').innerHTML = `
                <div class="offline-msg">
                    <h2 style="color:var(--accent);">No Internet Connection</h2>
                    <p>Please check your data or Wi-Fi.</p>
                    <button class="retry-btn" onclick="window.location.reload()">Retry ↻</button>
                </div>
            `;
        }

        // --- CONFIG DATA ---
        const examSubjects = {
            "OAV": ["English", "Math", "Science", "Social Science"],
            "NAVODAYA": ["Mental Ability", "Math", "Language"],
            "EKALABYA": ["Mental Ability", "Math", "English"],
            "PATHANI SAMANTA": ["Math"],
            "NMMS": ["Mental Ability", "Math", "Science", "Social Science"]
        };

        let currentExam = "";
        
        // --- DOM ELEMENTS ---
        const viewExams = document.getElementById('view-exams');
        const viewSubjects = document.getElementById('view-subjects');
        const viewQuiz = document.getElementById('view-quiz');
        const examGrid = document.getElementById('exam-grid');
        const subjectGrid = document.getElementById('subject-grid');
        const quizList = document.getElementById('quiz-list');

        // --- 1. INITIALIZE EXAM TILES ---
        function init() {
            examGrid.innerHTML = "";
            Object.keys(examSubjects).forEach(exam => {
                const tile = document.createElement('div');
                tile.className = 'tile';
                tile.innerText = exam;
                tile.onclick = () => showSubjects(exam);
                examGrid.appendChild(tile);
            });
        }
        init();

        // --- 2. SHOW SUBJECTS ---
        window.showSubjects = (exam) => {
            currentExam = exam;
            document.getElementById('selected-exam-title').innerText = exam;
            
            subjectGrid.innerHTML = "";
            const subjects = examSubjects[exam];
            subjects.forEach(sub => {
                const tile = document.createElement('div');
                tile.className = 'tile subject-tile'; // Adds Red styling
                tile.innerText = sub;
                tile.onclick = () => loadQuiz(sub);
                subjectGrid.appendChild(tile);
            });

            viewExams.classList.add('hidden');
            viewSubjects.classList.remove('hidden');
        }

        // --- 3. LOAD QUIZ (FETCH DATA) ---
        window.loadQuiz = async (subject) => {
            document.getElementById('selected-subject-title').innerText = `${currentExam} > ${subject}`;
            viewSubjects.classList.add('hidden');
            viewQuiz.classList.remove('hidden');
            
            // Show Loader
            quizList.innerHTML = `
                <div class="loader-container">
                    <div class="loader"></div>
                    <p>Loading Verified Questions...</p>
                </div>
            `;

            try {
                // QUERY: Exam + Subject + Verified Only
                const q = query(
                    collection(db, "questions"), 
                    where("exam", "==", currentExam),
                    where("subject", "==", subject),
                    where("verified", "==", true), // Only Verified!
                    orderBy("timestamp", "desc")
                );

                const snapshot = await getDocs(q);
                
                quizList.innerHTML = "";
                if(snapshot.empty) {
                    quizList.innerHTML = '<div class="loader-container"><p>No verified questions found for this subject yet.</p></div>';
                    return;
                }

                snapshot.forEach(doc => {
                    renderQuestionCard(doc.data(), doc.id);
                });

            } catch (error) {
                console.error(error);
                quizList.innerHTML = `<div class="loader-container" style="color:var(--wrong)">
                    <strong>Error Loading Data</strong><br>
                    ${error.message}<br><br>
                    <em>If seeing "Index" error, ask Admin to check console.</em>
                </div>`;
            }
        }

        // --- 4. RENDER SINGLE QUESTION CARD ---
        function renderQuestionCard(data, id) {
            const card = document.createElement('div');
            card.className = 'quiz-card';

            const imgHTML = data.imageUrl ? `<img src="${data.imageUrl}" class="q-img">` : '';

            card.innerHTML = `
                ${imgHTML}
                <div class="q-text">Q: ${data.question}</div>
                <div class="options-grid" id="opts-${id}">
                    <button class="opt-btn" onclick="checkAns('${id}', 'A', '${data.answer}')">A) ${data.options.A}</button>
                    <button class="opt-btn" onclick="checkAns('${id}', 'B', '${data.answer}')">B) ${data.options.B}</button>
                    <button class="opt-btn" onclick="checkAns('${id}', 'C', '${data.answer}')">C) ${data.options.C}</button>
                    <button class="opt-btn" onclick="checkAns('${id}', 'D', '${data.answer}')">D) ${data.options.D}</button>
                </div>
                <div id="feedback-${id}" style="margin-top:15px; font-weight:bold; font-size:1.1em;"></div>
            `;
            quizList.appendChild(card);
        }

        // --- 5. CHECK ANSWER LOGIC ---
        window.checkAns = (id, selected, correct) => {
            const container = document.getElementById(`opts-${id}`);
            const buttons = container.getElementsByClassName('opt-btn');
            const feedback = document.getElementById(`feedback-${id}`);

            // Disable all buttons after click
            for(let btn of buttons) {
                btn.disabled = true;
                btn.style.cursor = "default";
                // Highlight the correct one
                if(btn.innerText.startsWith(correct + ")")) {
                    btn.classList.add('correct');
                }
            }

            // If selected was wrong, mark it red
            if(selected !== correct) {
                for(let btn of buttons) {
                    if(btn.innerText.startsWith(selected + ")")) {
                        btn.classList.add('wrong');
                    }
                }
                feedback.innerHTML = `<span style="color:var(--wrong)">❌ Incorrect. The answer is ${correct}.</span>`;
            } else {
                feedback.innerHTML = `<span style="color:var(--correct)">✅ Correct! Great Job.</span>`;
            }
        }

        // --- NAVIGATION FUNCTIONS ---
        window.goBackToExams = () => {
            viewSubjects.classList.add('hidden');
            viewExams.classList.remove('hidden');
        }

        window.goBackToSubjects = () => {
            viewQuiz.classList.add('hidden');
            viewSubjects.classList.remove('hidden');
        }
    </script>
</body>
</html>
