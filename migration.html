<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Migration Tool: Class 5 EVS</title>
    <style>
        body { font-family: sans-serif; padding: 40px; text-align: center; background: #f4f6f8; }
        .card { background: white; padding: 30px; max-width: 500px; margin: auto; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h2 { color: #d32f2f; margin-top: 0; }
        p { color: #555; line-height: 1.6; }
        #status { margin-top: 20px; font-weight: bold; padding: 10px; border-radius: 5px; }
        .btn { background: #1a73e8; color: white; padding: 12px 24px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 15px; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

    <div class="card">
        <h2>‚ö†Ô∏è Database Migration Tool</h2>
        <p>This tool will move all <strong>5th Board</strong> questions from:</p>
        <ul style="text-align:left; display:inline-block;">
            <li>Samajika Bigyan</li>
            <li>Paribesa Bigyan</li>
        </ul>
        <p>To the new subject: <strong>Environmental Studies (EVS)</strong>.</p>
        
        <button id="runBtn" class="btn" onclick="runMigration()">Start Migration</button>
        
        <div id="status"></div>
        <div id="log" style="text-align: left; margin-top: 20px; font-size: 12px; color: #666; max-height: 200px; overflow-y: auto;"></div>
    </div>

    <script type="module">
        // 1. Import your existing config
        import { db } from "./firebase-config.js";
        import { collection, query, where, getDocs, writeBatch, doc } 
        from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        window.runMigration = async () => {
            const btn = document.getElementById('runBtn');
            const status = document.getElementById('status');
            const log = document.getElementById('log');
            
            btn.disabled = true;
            btn.innerText = "Scanning Database...";
            status.innerText = "‚è≥ Scanning for questions...";
            log.innerHTML = "";

            try {
                // 2. Define the Query: Look for Class 5 questions
                // Note: We fetch ALL 5th board questions to be safe and check subjects client-side
                // because Firestore doesn't support "OR" queries (IN array) easily in older versions without specific indexes.
                const q = query(
                    collection(db, "questions"), 
                    where("exam", "==", "5TH BOARD")
                );

                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    status.innerText = "‚ùå No Class 5 questions found.";
                    btn.disabled = false;
                    return;
                }

                // 3. Filter for the specific subjects we want to move
                const oldSubjects = ["Samajika Bigyan", "Paribesa Bigyan"];
                const docsToUpdate = [];

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Check if the subject matches our target list
                    if (oldSubjects.includes(data.subject)) {
                        docsToUpdate.push(doc);
                    }
                });

                if (docsToUpdate.length === 0) {
                    status.innerText = "‚úÖ No questions need moving. They are already correct!";
                    status.style.background = "#e8f5e9";
                    status.style.color = "#2e7d32";
                    return;
                }

                status.innerText = `üîÑ Found ${docsToUpdate.length} questions to move...`;

                // 4. Perform Batch Updates (Firestore allows 500 writes per batch)
                // We will chunk them just in case you have many questions
                const batchSize = 450; 
                const chunks = [];
                
                for (let i = 0; i < docsToUpdate.length; i += batchSize) {
                    chunks.push(docsToUpdate.slice(i, i + batchSize));
                }

                let processed = 0;

                for (const chunk of chunks) {
                    const batch = writeBatch(db);
                    chunk.forEach((docSnapshot) => {
                        const ref = doc(db, "questions", docSnapshot.id);
                        
                        // THE ACTUAL UPDATE: Change subject to EVS
                        batch.update(ref, { subject: "Environmental Studies (EVS)" });
                        
                        log.innerHTML += `<div>Prepared: ${docSnapshot.id} (${docSnapshot.data().subject})</div>`;
                    });

                    await batch.commit();
                    processed += chunk.length;
                    status.innerText = `üîÑ Updated ${processed} / ${docsToUpdate.length} questions...`;
                }

                // 5. Success Message
                status.innerText = "üéâ Migration Complete! All questions moved to EVS.";
                status.style.background = "#e8f5e9";
                status.style.color = "#2e7d32";
                btn.innerText = "Done";

            } catch (error) {
                console.error(error);
                status.innerText = "‚ùå Error: " + error.message;
                status.style.background = "#ffebee";
                status.style.color = "#d32f2f";
                btn.disabled = false;
            }
        };
    </script>
</body>
</html>
